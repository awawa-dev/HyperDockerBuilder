ARG DOCKER_SOURCE
FROM ${DOCKER_SOURCE}

# switch to RPi OS if needed
RUN apt-get update
RUN if [[ "${DOCKER_SOURCE}" == arm64* ]] || [[ "${DOCKER_SOURCE}" == arm32* ]]; then \
        apt-get install -y --no-install-recommends curl gnupg && \
        . /etc/os-release && \
        curl -fsSL "https://archive.raspberrypi.org/debian/raspberrypi.gpg.key" | gpg --dearmor -o /usr/share/keyrings/raspberrypi-archive-keyring.gpg && \
        echo "deb [signed-by=/usr/share/keyrings/raspberrypi-archive-keyring.gpg] http://archive.raspberrypi.org/debian/ ${VERSION_CODENAME} main" > /etc/apt/sources.list.d/raspberrypi.list && \
        rm -rf /var/lib/apt/lists/* && \
        apt-get update && \
        apt-get full-upgrade -y && \
        (apt-get install -y --no-install-recommends libcec-dev libp8-platform-dev libraspberrypi-bin libraspberrypi-dev raspi-gpio libdrm-dev || true) && \
        (apt-get install -y --no-install-recommends mesa-vulkan-drivers || true); \
    else \
        echo "Skipping Raspberry Pi OS repository, architecture is ${DOCKER_ARCHITECTURE}"; \
    fi

# install the packages required by HyperHDR
RUN apt-get upgrade -y
RUN apt-get install -y \
    build-essential \
    cmake \
    flatbuffers-compiler \
    git \
    libasound2-dev \
    libayatana-appindicator3-dev \
    libegl-dev \
    libflatbuffers-dev \
    libftdi1-dev \
    libgl-dev \
    libglvnd-dev \
    libgtk-3-dev \
    liblzma-dev \
    libpipewire-0.3-dev \
    libssl-dev \
    libsystemd-dev \
    libturbojpeg0-dev \
    libusb-1.0-0-dev \
    libx11-dev \
    libzstd-dev \
    lld \    
    ninja-build \
    patchelf \
    pkg-config \
    python3 \
    unzip \
    wget

RUN apt --assume-yes install libcec-dev libp8-platform-dev || true

RUN mkdir -p /scripts
COPY build.sh /scripts
WORKDIR /scripts
RUN chmod +x /scripts/build.sh
RUN /scripts/build.sh

